<!-- report_settings.html -->

{% extends "index.html" %}

{% block tips %}
 <!-- исключаю блок из блоков отображаемых на странице -->
{% endblock tips %}

{% block container %}
{{ super() }}

<div class="flex">
    <div class="report_side__list">
        <!-- Types -->
        <div class="types">
            <form method="POST">
                <div class="flex">
                    <label for="new_type" class="report_label__item">New Type:</label>
                    <input class="report_input__item" type="text" id="new_type" name="new_type">
                    <button class="btn report__btn" type="submit" name="add_new_type_button">Add Type</button>
                </div>
            </form>
            <div class="report_borderline"></div>
            <ul>
                <li>
                    <div class="type_list">
                        <label class="report_label__item" for="type_type">Edit Types:</label>
                        <div>
                        {% for type in user_types %}
                            <form method="POST" class="flex">
                                <input class="report_input__item" type="hidden" id="type_id" name="type_id" value="{{ type.id }}">
                                <input class="report_input__item" type="text" id="type_type" name="type_type" value="{{ type.type }}">
                                <button class="btn report__btn" type="submit" name="delete_type_button">Delete Type</button>
                                <button class="btn report__btn" type="submit" name="edit_type_button">Edit Type</button>
                            </form>
                        {% endfor %}
                        </div>
                    </div>
                    <div class="report_borderline"></div>
                </li>
            </ul>
        </div>

        <!-- Subtypes -->
        <div class="subtypes">
            <form method="POST" class="flex">
                <label class="report_label__item" for="report_subtype_type">New Subtype:</label>
                <select class="report__select report__select--type" id="report_subtype_type" name="report_subtype_type" required>
                    {% for type in user_types %}
                        <option value="{{ type.id }}">{{ type.type }}</option>
                    {% endfor %}
                </select>
                <input class="report_input__item" type="text" id="new_subtype" name="new_subtype">
                <button class="btn report__btn" type="submit" name="add_new_subtype_button">Add Subtype</button>
            </form>
            <div class="report_borderline"></div>
            <ul>
                <li>
                    <div class="subtype_list">
                        <label class="report_label__item" for="subtype_subtype">Edit Subtypes:</label>
                        {% for subtype in user_subtypes %}
                            <form method="POST" class="flex">
                                <input class="report_input__item" type="hidden" id="subtype_id" name="subtype_id" value="{{ subtype.id }}" readonly>
                                <input class="report_input__item" type="text" id="subtype_subtype" name="subtype_subtype" value="{{ subtype.subtype }}">
                                <input class="report_input__item" type="text" id="subtype_type" name="subtype_type" value="{{ subtype.report_type_rel.type }}" readonly>
                                <button class="btn report__btn" type="submit" name="delete_subtype_button">Delete Subtype</button>
                                <button class="btn report__btn" type="submit" name="edit_subtype_button">Edit Subtype</button>
                            </form>
                        {% endfor %}
                    </div>
                    <div class="report_borderline"></div>
                </li>
            </ul>
        </div>

        <!-- Directory and name Picker -->
        <div class="container">
            <form method="POST" id="directory-form">
                <label for="directory-path" class="report_label__item">Select Directory:</label>
                <input type="text" id="directory-path" name="directory_path" value="{{ upload_folder_path }}" readonly>
                <button type="button" class="btn report__btn" onclick="document.getElementById('file-input').click()">Choose Directory</button>
                <input type="file" id="file-input" webkitdirectory directory style="display:none;" onchange="updateDirectoryPath()">
                <button type="submit" class="btn report__btn" name="save_directory_button">Save Directory</button>
            </form>
            <form method="POST" id="folder-name-form">
                <label for="folder-name" class="report_label__item">Folder Name:</label>
                <input type="text" id="folder-name" name="folder_name" value="{{ upload_folder_name }}">
                <button type="submit" class="btn report__btn" name="save_folder_name_button">Save Folder Name</button>
            </form>
        </div>

        <div class="container">
            <h3>Upload File</h3>
            <form method="POST" enctype="multipart/form-data">
                <input type="file" name="file">
                <button type="submit">Upload</button>
            </form>
        </div>
    </div>
    
    
   <!-- Key words processing -->
    <div class="report_side--right">
        <form id="keywords-form">
            <label for="key_word_input" class="report_label__item">New Key Words (comma-separated):</label>
            <input type="text" id="key_word_input" name="key_word_input" required>
            <!-- Чекбокс для выбора связывания с отчетом -->
            <div>
                <label for="link_reports_checkbox" class="report_label__item">Link to Reports:</label>
                <input type="checkbox" id="link_reports_checkbox" name="link_reports_checkbox">
            </div>
            <!-- Список reports пользователя -->
            <div id="report-checkboxes-container" style="display: none;">
                <label class="report_label__item">Select Reports:</label>
                <div>
                    {% for report in user_reports %}
                        <label>
                            <input type="checkbox" name="report_ids" value="{{ report.id }}">
                            {{ report.report_name }}
                        </label><br>
                    {% endfor %}
                </div>
            </div>
            <button type="submit" class="btn report__btn">Add Key Words Group</button>
        </form>

        <div class="container">
            <h3>Key Words</h3>
            <div id="key-words-list">
                {% if key_words_group %}
                    {% for key_words in key_words_group %}
                        {% if not key_words['linked_reports'] %}
                            <div class="key-words-group" data-group="{{ key_words['keywords'][0].group_index }}">
                                {% for key_word in key_words['keywords'] %}
                                    <span data-group="{{ key_word.group_index }}" data-index="{{ key_word.index }}">
                                        {{ key_word.key_word }}{% if not loop.last %}, {% endif %}
                                    </span>
                                {% endfor %}
                                <!-- Кнопки для редактирования ключевых слов в группе -->
                                <button class="btn report__btn delete-keywords-btn" data-group="{{ key_words['keywords'][0].group_index }}">Delete</button>
                                <button class="btn report__btn edit-keywords-btn" data-group="{{ key_words['keywords'][0].group_index }}">Edit</button>
                                <!-- Поле для ввода ключевого слова, которое будет показано при нажатии на кнопку -->
                                <div class="add-keyword-input" style="display:none;" data-group="{{ key_words['keywords'][0].group_index }}">
                                <input type="text" placeholder="Enter new keyword(s)" class="new-keyword-input">
                                <button class="btn report__btn submit-keyword-btn" data-group="{{ key_words['keywords'][0].group_index }}">Submit</button>
                                </div>
                                <button class="btn report__btn add-keywords-btn" data-group="{{ key_words['keywords'][0].group_index }}">Add Word</button>
                                
                            </div>
                            {% else %}
                                <div class="key-words-group" data-group="{{ key_words['keywords'][0].group_index }}">
                                    {% for key_word in key_words['keywords'] %}
                                        <span data-group="{{ key_word.group_index }}" data-index="{{ key_word.index }}">
                                            {{ key_word.key_word }}{% if not loop.last %}, {% endif %}
                                        </span>
                                    {% endfor %}
                                    <div>
                                        Связанные отчеты:
                                        {% for report_id in key_words['linked_reports'] %}
                                            <span>Report ID: {{ report_id }}</span>{% if not loop.last %}, {% endif %}
                                        {% endfor %}
                                    </div>
                                    <!-- Кнопки для редактирования ключевых слов в группе -->
                                    <button class="btn report__btn delete-keywords-btn" data-group="{{ key_words['keywords'][0].group_index }}">Delete</button>
                                    <button class="btn report__btn edit-keywords-btn" data-group="{{ key_words['keywords'][0].group_index }}">Edit</button>
                                    <!-- Поле для ввода ключевого слова, которое будет показано при нажатии на кнопку -->
                                    <div class="add-keyword-input" style="display:none;" data-group="{{ key_words['keywords'][0].group_index }}">
                                        <input type="text" placeholder="Enter new keyword(s)" class="new-keyword-input">
                                        <button class="btn report__btn submit-keyword-btn" data-group="{{ key_words['keywords'][0].group_index }}">Submit</button>
                                    </div>
                                    <button class="btn report__btn add-keywords-btn" data-group="{{ key_words['keywords'][0].group_index }}">Add Word</button>
                                </div>
                            {% endif %}
                    {% endfor %}
                    
                {% else %}
                    <p>No key words found.</p>
                {% endif %}
            </div>
        </div>
    </div>
   

</div>

<script>

    // File directory logic
    function updateDirectoryPath() {
        var input = document.getElementById('file-input');
        var path = input.files[0].webkitRelativePath;
        document.getElementById('directory-path').value = path.split('/')[0];
    }

    // Показываем поле для ввода ключевых слов при нажатии на кнопку "Add Word"
    document.querySelectorAll(".add-keywords-btn").forEach(button => {
        button.addEventListener("click", function() {
            const groupIndex = this.dataset.group;
            const inputContainer = document.querySelector(`.add-keyword-input[data-group='${groupIndex}']`);
            if (inputContainer) {
                inputContainer.style.display = inputContainer.style.display === "none" ? "inline-block" : "none";
            }
        });
    });

    // Логика отправки нового ключевого слова (работа кнопки add word)
    document.querySelectorAll(".submit-keyword-btn").forEach(button => {
        button.addEventListener("click", function() {
            const groupIndex = this.dataset.group;
            const inputElement = document.querySelector(`.add-keyword-input[data-group='${groupIndex}'] .new-keyword-input`);
            const newKeywords = inputElement.value.trim();

            if (!newKeywords) {
                alert("Please enter at least one keyword.");
                return;
            }

            // Отправляем ключевые слова на сервер
            fetch("{{ url_for('report_settings.add_word_to_exist_group') }}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ group_index: groupIndex, key_word_input: newKeywords })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    location.reload(); // Перезагружаем страницу при успешном добавлении
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error("Error:", error);
            });
        });
    });


    // Показываем или скрываем список отчетов при выборе чекбокса
    document.getElementById('link_reports_checkbox').addEventListener('change', function() {
        const reportCheckboxesContainer = document.getElementById('report-checkboxes-container');
        if (this.checked) {
            reportCheckboxesContainer.style.display = 'block';
        } else {
            reportCheckboxesContainer.style.display = 'none';
        }
    });


    // Добавление нового ключевого слова на страницу
    document.getElementById("keywords-form").addEventListener("submit", function(event) {
        event.preventDefault();
        
        const keyWordInput = document.getElementById("key_word_input").value;
        const linkReportsCheckbox = document.getElementById("link_reports_checkbox").checked;

        // Собираем выбранные отчеты, если чекбокс отмечен
        let reportIds = [];
        if (linkReportsCheckbox) {
            const reportCheckboxes = document.querySelectorAll('input[name="report_ids"]:checked');
            reportCheckboxes.forEach(checkbox => reportIds.push(checkbox.value));
        }

        // Отправляем данные на сервер
        fetch("{{ url_for('report_settings.add_keywords') }}", {
            method: "POST", // Используем POST
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ 
                key_word_input: keyWordInput,
                report_ids: reportIds  // Передаем выбранные отчеты
            })
        })
        .then(response => {
            if (response.ok) {
                location.reload(); // Обновляем страницу при успешном добавлении
            } else {
                return response.json().then(data => alert(data.message));
            }
        })
        .catch(error => {
            console.error("Error:", error);
        });
    });

    

    // Логика для удаления ключевых слов по группе
    document.querySelectorAll(".delete-keywords-btn").forEach(button => {
        button.addEventListener("click", function() {
            const groupIndex = this.dataset.group;
            fetch("{{ url_for('report_settings.delete_keywords') }}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ group_index: groupIndex })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    const groupElement = document.querySelector(`.key-words-group[data-group='${groupIndex}']`);
                    if (groupElement) {
                        groupElement.remove();
                    } else {
                        console.error("Group element not found for deletion.");
                    }
                } else {
                    alert(data.message);
                }
            })
            .catch(error => console.error("Error:", error));
        });
    });

    // Логика для редактирования ключевых слов
    document.querySelectorAll(".edit-keywords-btn").forEach(button => {
        button.addEventListener("click", function() {
            const groupIndex = this.dataset.group;
            const groupElement = document.querySelector(`.key-words-group[data-group='${groupIndex}']`);

            if (groupElement) {
                const spans = groupElement.querySelectorAll("span");
                
                if (this.textContent === "Edit") {
                    // Преобразуем <span> в <input> для редактирования
                    spans.forEach(span => {
                        const input = document.createElement("input");
                        input.value = span.textContent.trim().replace(/,\s*$/, ''); // Убираем запятую, если есть
                        input.setAttribute("data-id", span.dataset.index);
                        input.classList.add("key-word-input");
                        span.replaceWith(input);
                    });
                    this.textContent = "Save";
                } else {
                    // Собираем изменения
                    const updatedWords = [];
                    const inputs = groupElement.querySelectorAll(".key-word-input");
                    inputs.forEach(input => {
                        updatedWords.push({ id: input.dataset.id, key_word: input.value.trim() });
                    });

                    // Отправляем изменения на сервер
                    fetch("{{ url_for('report_settings.edit_keywords') }}", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ group_index: groupIndex, words: updatedWords })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === "success") {
                            inputs.forEach(input => {
                                const span = document.createElement("span");
                                span.textContent = input.value.trim();
                                span.setAttribute("data-group", groupIndex);
                                span.setAttribute("data-index", input.dataset.id);
                                input.replaceWith(span);
                            });
                            this.textContent = "Edit";
                        } else {
                            alert(data.message);
                        }
                    })
                    .catch(error => console.error("Error:", error));
                }
            } else {
                console.error("Group element not found for editing.");
            }
        });
    });


    

</script>

{% endblock container %}
