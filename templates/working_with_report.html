<!-- working_with_report.html -->
{% extends "index.html" %}

{% block tips %}
 <!-- исключаю блок из блоков отображаемых на странице -->
{% endblock tips %}

{% block container %}
{{ super() }}


<!-- Pre-filled form for the second page -->
<form class="flex" id="exportForm">
    <div>
        <label for="patient-name">Name:</label>
        <input style="margin-right: 10px;" type="text" id="patient-name" name="patient_name" value="{{ full_name }}"readonly>
    </div>
    <div>
        <label for="patient-birthdate">Birthdate:</label>
        <input style="margin-right: 10px;" type="date" id="patient-birthdate" name="patient_birthdate" value="{{ birthdate }}"readonly>
    </div>
    <div>
        <label for="report-number">Report Number:</label>
        <input style="margin-right: 10px;" type="number" id="report-number" name="report_number" value="{{ report_number }}"readonly>
    </div>
    <!-- Контейнер для поля выбора стороны, скрыт по умолчанию -->
    {% if report.report_side == True %}
    <div>
        <label for="report-side">Side:</label>
        <select id="report-side" name="report_side">
            <option value=""></option>
            <option value="right">Right</option>
            <option value="left">Left</option>
        </select>
    </div>
    {% endif %}
    <button class="icon-btn icon-btn--edit-form" type="button"
        style="background: url('{{ url_for('static', filename='pic/edit_button.svg') }}') no-repeat center center;"
        title="Edit Form">
    </button>
</form>

<div class="flex">
    <!-- Left side -->
    <div class="report_side__list">
        <ul class="report_paragraph__list" id="left-paragraph-list">
            {% for item in paragraph_data %}
                <li class="flex_column report__paragraph">
                    <div class="flex">
                        <p contenteditable="false" data-paragraph-id="{{ item.paragraph.id }}"
                        class="paragraph-java-finder {% if item.paragraph.paragraph_visible %}bold-paragraph{% else %}indented-paragraph{% endif %}"
                        >
                            {{ item.paragraph.paragraph }}
                        </p>
                        {% if item.grouped_sentences %}
                            <button class="icon-btn icon-btn--expand" type="button"
                            style="background: url('{{ url_for('static', filename='pic/expand_button.svg') }}') no-repeat center center;"
                            title="Expand">
                            </button>
                        {% endif %}
                        <div class="flex edit-group" style="display: none;">
                            <button class="icon-btn icon-btn--edit-paragraph" type="button"
                            style="background: url('{{ url_for('static', filename='pic/edit_button.svg') }}') no-repeat center center;"
                            title="Edit Paragraph">
                            </button>
                            <button class="icon-btn icon-btn--delete-paragraph" type="button"
                            style="background: url('{{ url_for('static', filename='pic/delete_sentence_button.svg') }}') no-repeat center center;"
                            title="Delete Paragraph">
                            </button>
                        </div>
                    </div>
                    
                    <ul class="sentence-list" style="display: none;">
                        <li class="">
                            {% if item.grouped_sentences %}
                                {% for index, sentences in item.grouped_sentences.items() %}
                                    
                                        {% if sentences|length == 1 %}
                                            {% if sentences[0].index != 0 %}
                                                <div class="flex edit-container" sentence-index = "{{ sentences[0].index}}">
                                                    <p class="report__sentence" data-sentence-id="{{ sentences[0].id }}">{{ sentences[0].sentence }}</p>
                                                    <!-- button group -->
                                                    <div class="flex edit-group" style="display: none;">
                                                        <button class="icon-btn icon-btn--edit" type="button"
                                                        style="background: url('{{ url_for('static', filename='pic/edit_button.svg') }}') no-repeat center center;"
                                                        title="Edit">
                                                        </button>
                                                        <button class="icon-btn icon-btn--add_s_to_p" type="button"
                                                        style="background: url('{{ url_for('static', filename='pic/add_s_to_p_button.svg') }}') no-repeat center center;"
                                                        title="Add one more sentence below">
                                                        </button>
                                                        <button class="icon-btn icon-btn--add_s_to_s" type="button"
                                                        style="background: url('{{ url_for('static', filename='pic/add_s_to_s_button.svg') }}') no-repeat center center;"
                                                        title="Add sentence in sentences list">
                                                        </button>
                                                        <button class="icon-btn icon-btn--delete_sentence" type="button"
                                                        style="background: url('{{ url_for('static', filename='pic/delete_sentence_button.svg') }}') no-repeat center center;"
                                                        title="delete the sentence">
                                                        </button> 
                                                    </div>
                                                </div>
                                            {% endif %}
                                        {% else %}
                                            {% if sentences[0].index != 0 %}    
                                                <div class="flex edit-container">
                                                    <select class="report__select sentences_select" sentence-index = "{{ sentences[0].index}}" data-index="left-side-{{ item.paragraph.id }}-{{ index }}">
                                                        {% for sentence in sentences %}
                                                            <option value="{{ sentence.id }}" data-weigh = "{{ sentence.weight}}" data-sentence="{{ sentence.sentence }}">{{ sentence.sentence }}</option>
                                                        {% endfor %}
                                                    </select>
                                                    
                                                    <!-- button group -->
                                                    <div class="flex edit-group" style="display: none;">
                                                        <button class="icon-btn icon-btn--edit" type="button"
                                                        style="background: url('{{ url_for('static', filename='pic/edit_button.svg') }}') no-repeat center center;"
                                                        title="Edit">
                                                        </button>
                                                        <button class="icon-btn icon-btn--add_s_to_p" type="button"
                                                        style="background: url('{{ url_for('static', filename='pic/add_s_to_p_button.svg') }}') no-repeat center center;"
                                                        title="Add one more sentence below">
                                                        </button>
                                                        <button class="icon-btn icon-btn--add_s_to_s" type="button"
                                                        style="background: url('{{ url_for('static', filename='pic/add_s_to_s_button.svg') }}') no-repeat center center;"
                                                        title="Add sentence in sentences list">
                                                        </button>
                                                        <button class="icon-btn icon-btn--delete_sentence" type="button"
                                                        style="background: url('{{ url_for('static', filename='pic/delete_sentence_button.svg') }}') no-repeat center center;"
                                                        title="delete the sentence">
                                                        </button> 
                                                        <button class="icon-btn icon-btn--increase-weight" type="button" title="Increase weight">+</button>
                                                        <input type="number" class="sentence-weight-input" value="{{ sentences[0].weight }}" style="width: 50px;">
                                                        <button class="icon-btn icon-btn--decrease-weight" type="button" title="Decrease weight">-</button>
                                                        <button class="icon-btn icon-btn--save-weight" type="button" title="Save weight">s</button>
                                                    </div>
                                                </div>
                                            {% endif %}
                                        {% endif %}
                                    
                                {% endfor %}
                            {% endif %}
                        </li>
                    </ul>
                </li>
            {% endfor %}
        </ul>
        <button class="btn report__btn" id="toggleEditButton" title="Toggle Edit Mode">Edit</button>
    </div>
    
    <!-- Right side -->
    <div class="report_side__list report_side--right">
        <ul class="" id="right-paragraph-list">
            {% for item in paragraph_data %}
                <li class="report__paragraph">
                    <p contenteditable="true" data-paragraph-id="{{ item.paragraph.id }}" {% if item.paragraph.paragraph_visible %}class="report__paragraph--visible paragraph-java-finder" {% else %}class="report__paragraph--invisible paragraph-java-finder"{% endif %}>
                        {{ item.paragraph.paragraph }}
                    </p>
                    <ul class="">
                        <li class="">
                            {% if item.grouped_sentences %}
                                <p>
                                {% for index, sentences in item.grouped_sentences.items() %}
                                    {% if sentences[0].index != 0 %}
                                        <span contenteditable="true" class="report__sentence" data-index="right-side-{{ item.paragraph.id }}-{{ index }}"> {{ sentences[0].sentence }} </span>
                                        <!-- Кнопка "+" для добавления предложения -->
                                        <button class="icon-btn icon-btn--add-sentence" type="button" title="Add Sentence" data-paragraph-id="{{ item.paragraph.id }}">+</button>
                                    {% endif %}
                                {% endfor %}
                                </p>
                            {% endif %}
                        </li>
                    </ul>
                </li>
            {% endfor %}
        </ul>
        <!-- Button to copy text -->
        <button class="btn report__btn" id="copyButton">Copy Text</button>
        <button class="btn report__btn" id="exportButton">Export to Word</button>
        <button class="btn report__btn" id="generateImpression">Generate Impression</button>
    </div>
</div>
<div class="sentence_adding_reques-container" id="sentenceAddingRequestContainer">
    <!-- Здесь будет отображаться обработанный текст -->
    <p id="processedText"></p>
</div>

<script>

    // Функция для проверки, виден ли элемент на экране
    function isElementVisible(element) {
        const style = window.getComputedStyle(element);
        return style.display !== "none" && style.visibility !== "hidden";
    }


    // Функция для очистки текста от <select> элементов и кнопок, оставляя только выбранный текст
    function cleanSelectText(element) {
        let text = element.innerHTML;

        // Удаляем все кнопки из текста
        element.querySelectorAll("button").forEach(button => {
            button.remove();  // Удаляем кнопки из DOM, чтобы они не мешали сбору текста
        });

        // Заменяем все <select> на выбранный текст
        element.querySelectorAll("select").forEach(select => {
            const selectedOption = select.options[select.selectedIndex].textContent;
            text = text.replace(select.outerHTML, selectedOption);
        });

        // Убираем все HTML теги, кроме текста
        text = text.replace(/<[^>]*>?/gm, '').trim();

        // Удаляем лишние пробелы (оставляем только один пробел между словами)
        text = text.replace(/\s\s+/g, ' ');

        return text;
    }
    

    // Собираем текст из правой части экрана для дальнейшей его обработки
    function collectTextFromRightSide() {
        const rightParagraphList = document.getElementById("right-paragraph-list");
        let collectedText = "";

        // Проходим по каждому параграфу
        rightParagraphList.querySelectorAll(".report__paragraph").forEach(paragraphElement => {
            const paragraph = paragraphElement.querySelector("p");

            // Проверяем, видим ли параграф
            if (isElementVisible(paragraph)) {
                const paragraphText = paragraph.innerText.trim();
                collectedText += paragraphText + "\n";  // Добавляем текст параграфа
            }

            // Проходим по каждому предложению внутри параграфа
            paragraphElement.querySelectorAll(".report__sentence").forEach(sentenceElement => {
                // Проверяем, видимо ли предложение
                if (isElementVisible(sentenceElement)) {
                    const sentenceText = cleanSelectText(sentenceElement);
                    if (sentenceText) {
                        collectedText += sentenceText + " ";  // Добавляем текст предложения
                    }
                }
            });

            collectedText += "\n";  // Разделяем параграфы
        });

        return collectedText.trim();  // Убираем лишние пробелы и возвращаем текст
    }


    // функция для отображения предложений, которые мы предлагаем пользователю добавить в базу данных
    function displayProcessedParagraphs(paragraphs) {
        const container = document.getElementById('sentenceAddingRequestContainer');
        container.innerHTML = ''; // Очищаем контейнер перед добавлением новых данных
    
        // Проверка, есть ли данные для обработки
        if (!paragraphs || !Array.isArray(paragraphs)) {
            console.error("Invalid paragraphs data:", paragraphs);
            return;
        }
    
        paragraphs.forEach(paragraph => {
            const paragraphDiv = document.createElement('div');
            paragraphDiv.classList.add('paragraph-container');
    
            const paragraphText = paragraph.paragraph_text || `Paragraph: ${paragraph.paragraph_id}`;
            paragraphDiv.textContent = `Paragraph: ${paragraphText}`;
    
            // Проверка на массив предложений
            if (Array.isArray(paragraph.sentences)) {
                paragraph.sentences.forEach(sentence => {
                    const sentenceDiv = document.createElement('div');
                    sentenceDiv.classList.add('sentence-container');
                    sentenceDiv.textContent = sentence;
    
                    // Добавляем кнопку "Добавить" для каждого предложения
                    const addButton = document.createElement('button');
                    addButton.textContent = 'Добавить';
                    addButton.classList.add('add-sentence-btn');
                    addButton.addEventListener('click', function() {
                        // Отправляем предложение на сервер
                        addSentenceToDatabase(paragraph.paragraph_id, sentence);
                    });
    
                    sentenceDiv.appendChild(addButton); // Добавляем кнопку к предложению
                    paragraphDiv.appendChild(sentenceDiv);
                });
            } else if (typeof paragraph.sentence === 'string') {
                // Если предложение передано как строка (единичное предложение)
                const sentenceDiv = document.createElement('div');
                sentenceDiv.classList.add('sentence-container');
                sentenceDiv.textContent = paragraph.sentence;
    
                // Добавляем кнопку "Добавить" для предложения
                const addButton = document.createElement('button');
                addButton.textContent = 'Добавить';
                addButton.classList.add('add-sentence-btn');
                addButton.addEventListener('click', function() {
                    // Отправляем предложение на сервер
                    addSentenceToDatabase(paragraph.paragraph_id, paragraph.sentence);
                });
    
                sentenceDiv.appendChild(addButton);
                paragraphDiv.appendChild(sentenceDiv);
            } else {
                console.error('No valid sentences found for paragraph:', paragraph);
            }
    
            container.appendChild(paragraphDiv);
        });
    }
    

    // Функция для отправки предложения на сервер
    function addSentenceToDatabase(paragraphId, sentenceText) {
        fetch("{{ url_for('working_with_reports.add_sentence_to_paragraph') }}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                paragraph_id: paragraphId,
                sentence_text: sentenceText
            })
        }).then(response => {
            if (response.ok) {
                response.json().then(data => {
                    alert("Sentence added successfully!");
                });
            } else {
                alert("Failed to add sentence.");
            }
        });
    }

    // Функция для отправки данных на сервер в маршрут new_sentence_adding где будет произведен поиск новых предложений в тексте справа
    function sendParagraphsToServer(paragraphsData) {
        fetch("{{ url_for('working_with_reports.new_sentence_adding') }}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                paragraphs: paragraphsData
            })
        }).then(response => {
            if (response.ok) {
                response.json().then(data => {
                    displayProcessedParagraphs(data.processed_paragraphs);
                });
            } else {
                alert("Failed to process paragraphs.");
            }
        });
    }

    // Функция для формирования данных параграфов и предложений для формирования предложений для добавления в базу данных
    function collectParagraphsData() {
        const rightParagraphList = document.getElementById("right-paragraph-list");
        const paragraphsData = [];
    
        rightParagraphList.querySelectorAll(".report__paragraph").forEach(paragraphElement => {
            const paragraph = paragraphElement.querySelector("p");
    
            // Проверяем, виден ли параграф на экране
                const paragraphId = paragraph.getAttribute("data-paragraph-id");
                const paragraphText = paragraph.innerText.trim();
                const sentences = [];
    
                paragraphElement.querySelectorAll(".report__sentence").forEach(sentenceElement => {
                    const sentenceText = cleanSelectText(sentenceElement);
                    if (sentenceText) {
                        sentences.push(sentenceText);
                    }
                });
    
                if (sentences.length > 0) {
                    paragraphsData.push({
                        paragraph_id: paragraphId,
                        paragraph_text: paragraphText,
                        sentences: sentences
                    });
                }
        });
    
        return paragraphsData;
    }
    

    // Функция для выделения ключевых слов и работы с ними
    function highlightKeyWords(text, keyWordsGroups) {
        const matchIndexes = {};
    
        // Функция для проверки, является ли символ буквой (учитывает кириллицу и латиницу)
        function isLetter(char) {
            return /[a-zA-Zа-яА-ЯёЁ]/.test(char);
        }
    
        // Проходим по каждой группе ключевых слов
        keyWordsGroups.forEach(group => {
            group.forEach(word => {
                if (!matchIndexes[word]) {
                    matchIndexes[word] = 0;
                }
    
                // Регулярное выражение для нахождения ключевого слова вне тегов и без букв перед и после
                const regex = new RegExp(`(?<!<[^>]*>|[a-zA-Zа-яА-ЯёЁ])(${word})(?![^<]*>|[a-zA-Zа-яА-ЯёЁ])`, 'gi');
    
                text = text.replace(regex, (matchedWord, offset, fullText) => {
                    matchIndexes[word] += 1;
    
                    // Создаём select с опциями из той же группы слов
                    const options = group.map(optionWord => {
                        const isSelected = optionWord.toLowerCase() === matchedWord.toLowerCase() ? "selected" : "";
                        return `<option value="${optionWord}" ${isSelected}>${optionWord}</option>`;
                    }).join('');
    
                    return `<select class="report__select_dynamic" data-match-index="${word}-${matchIndexes[word]}">${options}</select>`;
                });
            });
        });
    
        return text;
    }
    
    
    // Function Logic for finding key_words
    function updateRightSideText() {
        const keyWordsGroups = {{ key_words|tojson }};
        const rightParagraphList = document.getElementById("right-paragraph-list");

        rightParagraphList.querySelectorAll("p, span").forEach(paragraph => {
            const currentIndex = paragraph.getAttribute("data-index");

            if (!currentIndex) {
                return;
            }

            let plainText = paragraph.innerText || paragraph.textContent;

            if (!paragraph.querySelector('select')) {
                const highlightedText = highlightKeyWords(plainText, keyWordsGroups);
                paragraph.innerHTML = highlightedText;
            }

            paragraph.setAttribute("data-index", currentIndex);
        });
    }
    
    
    // Renewing of the right side text for key_words logic working
    document.addEventListener("DOMContentLoaded", function() {
        updateRightSideText(); 
    });

     // Toggle Edit Mode
     document.getElementById("toggleEditButton").addEventListener("click", function() {
        const editGroups = document.querySelectorAll(".edit-group");
        const isEditing = this.classList.toggle("editing-mode");

        editGroups.forEach(group => {
            group.style.display = isEditing ? "flex" : "none";
        });
    });
    
    // Set Weigh button logic
    document.querySelectorAll(".report__select").forEach(selectElement => {
        // Инициализация кнопки при загрузке
        updateWeightButton(selectElement);
    
        // Обновление кнопки при изменении выбора
        selectElement.addEventListener("change", function() {
            updateWeightButton(selectElement);
        });
    });
    
    // Функция для обновления отображаемого значения веса
    function updateWeightButton(selectElement) {
        const selectedOption = selectElement.selectedOptions[0];
        const weight = selectedOption.getAttribute("data-weigh");
        const container = selectElement.closest(".edit-container");
        const weightInput = container.querySelector(".sentence-weight-input");
    
        if (weightInput) {
            weightInput.value = weight;
        }
    }

    // Increase button logic
    document.querySelectorAll(".icon-btn--increase-weight").forEach(button => {
        button.addEventListener("click", function() {
            const container = this.closest(".edit-container");
            const weightInput = container.querySelector(".sentence-weight-input");
            let currentWeight = parseInt(weightInput.value, 10);
            currentWeight += 1;
            weightInput.value = currentWeight;
        });
    });

    // Decrise button logic
    document.querySelectorAll(".icon-btn--decrease-weight").forEach(button => {
        button.addEventListener("click", function() {
            const container = this.closest(".edit-container");
            const weightInput = container.querySelector(".sentence-weight-input");
            let currentWeight = parseInt(weightInput.value, 10);
            currentWeight -= 1;
            weightInput.value = currentWeight;
        });
    });

    // "s" button logic for save sentence's weight to the bd
    document.querySelectorAll(".icon-btn--save-weight").forEach(button => {
        button.addEventListener("click", function() {
            const container = this.closest(".edit-container");
            const weightInput = container.querySelector(".sentence-weight-input");
            const selectElement = container.querySelector(".report__select");
            const selectedOption = selectElement.selectedOptions[0];
            const sentenceId = selectedOption.value;
            const newWeight = parseInt(weightInput.value, 10);
    
            fetch("{{ url_for('working_with_reports.update_sentence_weight') }}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    sentence_id: sentenceId,
                    new_weight: newWeight
                })
            }).then(response => {
                if (response.ok) {
                    alert("Weight updated successfully!");
                    selectedOption.setAttribute("data-weigh", newWeight);
                } else {
                    alert("Failed to update weight.");
                }
            });
        });
    });
    
    // Button "expand" logic
    document.querySelectorAll(".icon-btn--expand").forEach(button => {
        button.addEventListener("click", function() {
            const sentenceList = this.closest(".report__paragraph").querySelector(".sentence-list");
            if (sentenceList.style.display === "none") {
                sentenceList.style.display = "block";
                this.classList.add("expanded"); 
                this.classList.remove("collapsed");
                this.title = "Collapse"; 
            } else {
                sentenceList.style.display = "none";
                this.classList.remove("expanded"); 
                this.classList.add("collapsed");
                this.title = "Expand"; 
            }
        });
    });
    
    // Button edit logic for editing name, date of birth etc
    document.addEventListener("DOMContentLoaded", function() {
        const editButton = document.querySelector(".icon-btn--edit-form");
        const formInputs = document.querySelectorAll("#exportForm input");
    
        editButton.addEventListener("click", function() {
            // Check if the inputs are currently read-only
            const isReadOnly = formInputs[0].hasAttribute("readonly");
    
            formInputs.forEach(input => {
                if (isReadOnly) {
                    input.removeAttribute("readonly"); // Make inputs editable
                } else {
                    input.setAttribute("readonly", true); // Make inputs read-only
                }
            });
    
            // Change the button icon accordingly
            if (isReadOnly) {
                editButton.style.background = "url('{{ url_for('static', filename='pic/save_button.svg') }}') no-repeat center center";
                editButton.title = "Save Changes";
            } else {
                editButton.style.background = "url('{{ url_for('static', filename='pic/edit_button.svg') }}') no-repeat center center";
                editButton.title = "Edit Form";
            }
        });
    });
    

   // Button "Edit" logic with icon change for sentences
    document.querySelectorAll(".icon-btn--edit").forEach(button => {
        button.addEventListener("click", function() {
            const container = this.closest(".edit-container");
            const sentenceElement = container.querySelector(".report__sentence");
            const selectElement = container.querySelector(".report__select");

            if (this.classList.contains("editing")) {
                // Save logic
                const sentenceId = sentenceElement ? sentenceElement.getAttribute("data-sentence-id") : selectElement.value;
                const newValue = sentenceElement ? sentenceElement.innerText : container.querySelector(".report__input").value;

                fetch("{{ url_for('working_with_reports.update_sentence') }}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        sentence_id: sentenceId,
                        new_value: newValue
                    })
                }).then(response => {
                    if (response.ok) {
                        alert("Sentence updated successfully!");
                        this.classList.remove("editing");
                        this.style.background = "url('{{ url_for('static', filename='pic/edit_button.svg') }}') no-repeat center center";
                        if (selectElement) {
                            const input = container.querySelector(".report__input");
                            const selectedOption = selectElement.selectedOptions[0];
                            selectedOption.setAttribute("data-sentence", input.value);
                            selectedOption.textContent = input.value;
                            input.remove();
                            selectElement.style.display = "inline-block";
                        } else {
                            sentenceElement.contentEditable = false;
                            sentenceElement.classList.remove("editing");
                        }
                    } else {
                        alert("Failed to update sentence.");
                    }
                });
            } else {
                // Edit logic
                this.classList.add("editing");
                this.style.background = "url('{{ url_for('static', filename='pic/save_button.svg') }}') no-repeat center center";

                if (selectElement) {
                    const selectedOption = selectElement.selectedOptions[0];
                    const sentenceText = selectedOption.getAttribute("data-sentence");
                    const input = document.createElement("input");
                    input.type = "text";
                    input.value = sentenceText;
                    input.className = "report__input";
                    container.insertBefore(input, selectElement);
                    selectElement.style.display = "none";
                } else {
                    sentenceElement.contentEditable = true;
                    sentenceElement.classList.add("editing");
                }
            }
        });
    });
 
    // Button "Edit Paragraph" logic
    document.querySelectorAll(".icon-btn--edit-paragraph").forEach(button => {
        button.addEventListener("click", function() {
            const paragraphElement = this.closest("li").querySelector(".paragraph-java-finder");
            
            // Проверка на null
        if (!paragraphElement) {
            console.error("Paragraph element not found.");
            return;
        }

            const paragraphId = paragraphElement.getAttribute("data-paragraph-id");

            if (this.classList.contains("editing")) {
                // Save logic for paragraph
                const newParagraphValue = paragraphElement.innerText;

                fetch("{{ url_for('working_with_reports.update_paragraph') }}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        paragraph_id: paragraphId,
                        new_value: newParagraphValue
                    })
                }).then(response => {
                    if (response.ok) {
                        alert("Paragraph updated successfully!");
                        this.classList.remove("editing");
                        paragraphElement.contentEditable = false;
                        paragraphElement.classList.remove("editing");
                        this.style.background = "url('{{ url_for('static', filename='pic/edit_button.svg') }}') no-repeat center center";
                    } else {
                        alert("Failed to update paragraph.");
                    }
                });
            } else {
                // Edit logic for paragraph
                this.classList.add("editing");
                paragraphElement.contentEditable = true;
                paragraphElement.classList.add("editing");
                this.style.background = "url('{{ url_for('static', filename='pic/save_button.svg') }}') no-repeat center center";
            }
        });
    });


   // Button "Add s to p" logic - adding sentence to the paragraph
    document.querySelectorAll(".icon-btn--add_s_to_p").forEach(button => {
        button.addEventListener("click", function() {
            const container = this.closest(".edit-container");
            const sentenceElement = container.querySelector(".report__sentence");
            const selectElement = container.querySelector(".report__select");
        
            let paragraphId;
            let currentIndex;

            if (selectElement) {
                // Если предложения сгруппированы в select, получаем ID параграфа и индекс
                paragraphId = selectElement.getAttribute("data-index").split("-")[2];
                currentIndex = parseInt(selectElement.getAttribute("sentence-index")); // Извлекаем индекс из атрибута sentence-index
            } else {
                // Для одиночных предложений
                paragraphId = container.closest(".report__paragraph").querySelector("p").getAttribute("data-paragraph-id");
                currentIndex = parseInt(sentenceElement.closest(".edit-container").getAttribute("sentence-index")); // Извлекаем индекс из атрибута sentence-index
            }

            // Отправляем запрос на сервер для добавления нового предложения
            fetch("{{ url_for('working_with_reports.add_sentence') }}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    paragraph_id: paragraphId,
                    index: currentIndex, 
                    add_to_list_flag: false
                })
            }).then(response => {
                if (response.ok) {
                    alert("Sentence added successfully!");
                    location.reload(); // Перезагрузка страницы для отображения нового предложения
                } else {
                    alert("Failed to add sentence.");
                }
            });
        });
    });


    // Button "Add s to s" logic - adding sentence to the sentences list aka select
    document.querySelectorAll(".icon-btn--add_s_to_s").forEach(button => {
        button.addEventListener("click", function() {
            const container = this.closest(".edit-container");
            const sentenceElement = container.querySelector(".report__sentence");
            const selectElement = container.querySelector(".report__select");
            
            let paragraphId;
            let currentIndex;
            if (selectElement) {
                paragraphId = selectElement.getAttribute("data-index").split("-")[2];
                currentIndex = parseInt(selectElement.getAttribute("sentence-index")); 

            } else {
                paragraphId = container.closest(".report__paragraph").querySelector("p").getAttribute("data-paragraph-id");
                currentIndex = parseInt(sentenceElement.closest(".edit-container").getAttribute("sentence-index"));
            }
            
            fetch("{{ url_for('working_with_reports.add_sentence') }}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    paragraph_id: paragraphId,
                    index: currentIndex, 
                    add_to_list_flag: true
                })
            }).then(response => {
                if (response.ok) {
                    alert("Sentence added successfully!");
                    location.reload(); // Перезагрузка страницы для отображения нового предложения
                } else {
                    alert("Failed to add sentence.");
                }
            });
        });
    });


    // Button "Delete" logic for sentences
    document.querySelectorAll(".icon-btn--delete_sentence").forEach(button => {
        button.addEventListener("click", function() {
            const container = this.closest(".edit-container");
            const selectElement = container.querySelector(".report__select");
            let sentenceId;

            if (selectElement) {
                // Если предложения сгруппированы в select
                const selectedOption = selectElement.selectedOptions[0];
                sentenceId = selectedOption.value; // Получаем sentence-id из value выбранной опции
            } else {
                // Для одиночных предложений
                const sentenceElement = container.querySelector(".report__sentence");
                sentenceId = sentenceElement.getAttribute("data-sentence-id");
            }

            const paragraphId = container.closest(".report__paragraph").querySelector("p").getAttribute("data-paragraph-id");

            if (confirm("Are you sure you want to delete this sentence?")) {
                fetch("{{ url_for('working_with_reports.delete_sentence') }}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        sentence_id: sentenceId,
                        paragraph_id: paragraphId
                    })
                }).then(response => {
                    if (response.ok) {
                        alert("Sentence deleted successfully!");
                        location.reload(); // Перезагрузка страницы для отображения обновленного списка предложений
                    } else {
                        alert("Failed to delete sentence.");
                    }
                });
            }
        });
    });

    // Button "Delete Paragraph" logic
    document.querySelectorAll(".icon-btn--delete-paragraph").forEach(button => {
        button.addEventListener("click", function() {
            const paragraphElement = this.closest("li").querySelector(".paragraph-java-finder");
            
            // Проверка на null
        if (!paragraphElement) {
            console.error("Paragraph element not found.");
            return;
        }
            
            const paragraphId = paragraphElement.getAttribute("data-paragraph-id");

            if (confirm("Are you sure you want to delete this paragraph?")) {
                fetch("{{ url_for('working_with_reports.delete_paragraph') }}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        paragraph_id: paragraphId
                    })
                }).then(response => {
                    if (response.ok) {
                        alert("Paragraph deleted successfully!");
                        paragraphElement.closest("li").remove();
                    } else {
                        alert("Failed to delete paragraph.");
                    }
                });
            }
        });
    });
    
    
    // Logic for renewing data on the right container then data on the left one was changed
    document.getElementById("left-paragraph-list").addEventListener("change", function(event) {
        if (event.target.tagName === "SELECT") {
            const index = event.target.getAttribute("data-index");
            const selectedOption = event.target.selectedOptions[0];
            const selectedSentence = selectedOption.getAttribute("data-sentence");
            const correspondingIndex = index.replace("left-side", "right-side");
            const correspondingParagraph = document.querySelector('[data-index="' + correspondingIndex + '"]');

            // Проверяем, найден ли соответствующий параграф на правой стороне
            if (correspondingParagraph) {
                correspondingParagraph.innerText = selectedSentence;
                // После обновления текста выделяем ключевые слова
                updateRightSideText();
            } else {
                console.error("Corresponding paragraph not found for index: " + correspondingIndex);
            }
        }
    });

    // Clean and format text before using it in the copy-to-clipboard and export-to-word function
    function cleanAndFormatText(element) {
        let formattedText = element.innerHTML;
    
        // Проходим по каждому select и заменяем его на выбранный текст
        element.querySelectorAll("select").forEach(function(select) {
            const selectedOption = select.options[select.selectedIndex].textContent;
            formattedText = formattedText.replace(select.outerHTML, selectedOption);
        });
    
        // Убираем все теги <span> и оставляем только текст внутри них
        formattedText = formattedText.replace(/<span[^>]*>(.*?)<\/span>/gi, function(match, p1) {
            return p1.trim(); // Возвращаем текст внутри span, удаляя лишние пробелы
        });
    
        // Удаляем лишние пробелы, табуляции и новые строки
        formattedText = formattedText.replace(/\s+/g, " ").trim();
    
        // Убираем лишние пробелы и пустые строки между абзацами
        formattedText = formattedText.replace(/\s*\n\s*/g, "\n").trim();
    
        return formattedText;
    }
    
    // Button "Copy to clipboard" logic
    document.getElementById("copyButton").addEventListener("click", function() {
        // Собираем текст из правой части экрана
        const textToCopy = collectTextFromRightSide();

        // Формируем данные параграфов и предложений
        const paragraphsData = collectParagraphsData();

        // Используем функцию для отправки данных на сервер
        sendParagraphsToServer(paragraphsData);

        navigator.clipboard.writeText(textToCopy.trim()).then(function() {
            alert("Text copied to clipboard");
        }).catch(function(err) {
            console.error("Failed to copy text: ", err);
        });
    });
    
    // "Export to word" button logic
    document.getElementById("exportButton").addEventListener("click", function() {
        // Собираем текст из правой части экрана для экспорта в Word
        const textToExport = collectTextFromRightSide();
        console.log("Collected text: ", textToExport);
        // Формируем данные параграфов и предложений
        const paragraphsData = collectParagraphsData();

        // Отправляем данные параграфов на сервер
        sendParagraphsToServer(paragraphsData);

        const name = document.getElementById("patient-name").value;
        const birthdate = document.getElementById("patient-birthdate").value;
        const reportnumber = document.getElementById("report-number").value;
        const subtype = "{{ subtype }}";
        const reportType = "{{ report_type }}";
        const scanParam = "{{ report.comment }}";
        const reportSideElement = document.getElementById("report-side");
        const reportSide = reportSideElement ? reportSideElement.value : "";

        fetch("{{ url_for('working_with_reports.export_to_word') }}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                text: textToExport,
                name: name,
                birthdate: birthdate,
                subtype: subtype,
                report_type: reportType,
                reportnumber: reportnumber,
                scanParam: scanParam,
                side: reportSide
            })
        }).then(response => {
            if (response.ok) {
                response.blob().then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.style.display = "none";
                    a.href = url;
                    a.download = `${name}_${subtype}.docx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                });
            } else {
                alert("Failed to export to Word.");
            }
        });
    });

    // Логика получения предложения с индексом 0 для конкретного параметра
    document.addEventListener("DOMContentLoaded", function() {
        // Функция для создания инпута для добавления нового предложения
        function createInputForNewSentence(buttonElement) {
            // Удаляем все активные элементы (селекты или инпуты)
            document.querySelectorAll(".dynamic-select, .dynamic-input").forEach(el => el.remove());
    
            // Создаем инпут для нового предложения
            const inputElement = document.createElement("input");
            inputElement.type = "text";
            inputElement.classList.add("dynamic-input");
            inputElement.placeholder = "Введите предложение";
    
            // Добавляем поле ввода перед кнопкой
            buttonElement.parentNode.insertBefore(inputElement, buttonElement);
    
            // Устанавливаем фокус на поле ввода
            inputElement.focus();
    
            // Обработка нажатия Enter для добавления предложения
            inputElement.addEventListener("keydown", function(event) {
                if (event.key === "Enter") {
                    const customSentence = inputElement.value.trim();
                    if (customSentence) {
                        // Создаем новый элемент <span> с введенным предложением и вставляем перед кнопкой
                        const newSentenceElement = document.createElement("span");
                        newSentenceElement.classList.add("report__sentence");
                        newSentenceElement.textContent = customSentence;
    
                        buttonElement.parentNode.insertBefore(newSentenceElement, buttonElement);
                        inputElement.remove();  // Удаляем поле ввода после добавления предложения
                    }
                }
            });
        }
    
        // Основная логика при нажатии на кнопку "+"
        document.querySelectorAll(".icon-btn--add-sentence").forEach(button => {
            button.addEventListener("click", function() {
                const paragraphId = this.getAttribute("data-paragraph-id");
                const buttonElement = this;
    
                // Удаляем предыдущие выпадающие списки или поля ввода, если они уже существуют
                document.querySelectorAll(".dynamic-select, .dynamic-input").forEach(el => el.remove());
                
                // Получаем предложения с индексом 0 для этого параграфа
                fetch("{{ url_for('working_with_reports.get_sentences_with_index_zero') }}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        paragraph_id: paragraphId  // Передаем ID параграфа
                    })
                }).then(response => response.json())
                .then(data => {
                    if (data.sentences && data.sentences.length > 0) {
                        // Создаем выпадающий список (select) с предложениями
                        const selectElement = document.createElement("select");
                        selectElement.classList.add("dynamic-select");

                        // Добавляем первое пустое поле, значение пустое, а текст — "Введите предложение"
                        const startOption = document.createElement("option");
                        startOption.value = "";  // Пустое значение для выбора
                        startOption.textContent = "Выберете предложение для добавления";  // Текст, который видит пользователь
                        selectElement.appendChild(startOption);

                        // Добавляем первое пустое поле, значение пустое, а текст — "Введите предложение"
                        const emptyOption = document.createElement("option");
                        emptyOption.value = "";  // Пустое значение для выбора
                        emptyOption.textContent = "Введите свое предложение";  // Текст, который видит пользователь
                        selectElement.appendChild(emptyOption);
    
                        // Добавляем остальные предложения с индексом 0
                        data.sentences.forEach(sentence => {
                            const option = document.createElement("option");
                            option.value = sentence.id;
                            option.textContent = sentence.sentence;
                            selectElement.appendChild(option);
                        });
                        selectElement.value = "";

                        
    
                        // Добавляем выпадающий список перед кнопкой
                        buttonElement.parentNode.insertBefore(selectElement, buttonElement);
    
                        // Обработка выбора предложения
                        selectElement.addEventListener("change", function() {
                            if (selectElement.value === "") {
                                // Если выбрано пустое поле, вызываем функцию для инпута
                                
                                createInputForNewSentence(buttonElement);
                                selectElement.remove();  // Удаляем выпадающий список
                            } else {
                                // Если выбрано предложение из списка, добавляем его в текст
                                const selectedSentence = selectElement.options[selectElement.selectedIndex].textContent;
    
                                // Создаем новый элемент <span> с предложением и вставляем перед кнопкой
                                const newSentenceElement = document.createElement("span");
                                newSentenceElement.classList.add("report__sentence");
                                newSentenceElement.textContent = selectedSentence;
    
                                buttonElement.parentNode.insertBefore(newSentenceElement, buttonElement);
                                selectElement.remove();  // Удаляем выпадающий список после добавления предложения
                            }
                        });
    
                    } else {
                        // Если предложений нет, вызываем функцию для инпута
                        createInputForNewSentence(buttonElement);
                    }
                }).catch(error => {
                    console.error("Error:", error);
                });
            });
        });
    });

</script>

{% endblock container %}
