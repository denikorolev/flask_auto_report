{% extends "index.html" %}

{% block container %}
{{ super() }}
<div class="flex">
    <!-- Left side -->
    <div class="report_side__list">
        <ul class="report_paragraph__list" id="left-paragraph-list">
            {% for item in paragraph_data %}
                <li class="report__paragraph">
                    <p contenteditable="true" data-paragraph-id="{{ item.paragraph.id }}" {% if item.paragraph.paragraph_visible %}class="report__paragraph--visible" {% else %}class="report__paragraph--invisible"{% endif %}>
                        {{ item.paragraph.paragraph }}
                    </p>
                    <ul class="">
                        <li class="">
                            {% if item.grouped_sentences %}
                                {% for index, sentences in item.grouped_sentences.items() %}
                                    {% if sentences|length == 1 %}
                                        <div class="flex edit-container">
                                            <p class="report__sentence" data-sentence-id="{{ sentences[0].id }}">{{ sentences[0].sentence }}</p>
                                            <button class="btn report__btn edit-btn" type="button">Edit</button>
                                            <button class="btn report__btn add-sentence-btn" type="button">Add s in p</button>
                                        </div>
                                    {% else %}
                                        <div class="flex edit-container">
                                            <select class="report__select" data-index="left-side-{{ item.paragraph.id }}-{{ index }}">
                                                {% for sentence in sentences %}
                                                    <option value="{{ sentence.id }}" data-sentence="{{ sentence.sentence }}">{{ sentence.sentence }}</option>
                                                {% endfor %}
                                            </select>
                                            <button class="btn report__btn edit-btn" type="button">Edit</button>
                                            <button class="btn report__btn add-sentence-btn" type="button">Add s in p</button>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </li>
                    </ul>
                </li>
            {% endfor %}
        </ul>
    </div>
    
    <!-- Right side -->
    <div class="report_side__list report_side--right">
        <ul class="" id="right-paragraph-list">
            {% for item in paragraph_data %}
                <li class="report__paragraph">
                    <p contenteditable="true" {% if item.paragraph.paragraph_visible %}class="report__paragraph--visible" {% else %}class="report__paragraph--invisible"{% endif %}>
                        {{ item.paragraph.paragraph }}
                    </p>
                    <ul class="">
                        <li class="">
                            {% if item.grouped_sentences %}
                                <p>
                                {% for index, sentences in item.grouped_sentences.items() %}
                                    <span contenteditable="true" class="report__sentence" data-index="right-side-{{ item.paragraph.id }}-{{ index }}"> {{ sentences[0].sentence }} </span>
                                {% endfor %}
                                </p>
                            {% endif %}
                        </li>
                    </ul>
                </li>
            {% endfor %}
        </ul>
        <!-- Button to copy text -->
        <button class="btn report__btn" id="copyButton">Copy Text</button>
    </div>
</div>

<script>
    document.querySelectorAll(".edit-btn").forEach(button => {
        button.addEventListener("click", function() {
            const container = this.closest(".edit-container");
            const sentenceElement = container.querySelector(".report__sentence");
            const selectElement = container.querySelector(".report__select");
    
            if (this.innerText === "Edit") {
                this.innerText = "Save";
    
                if (selectElement) {
                    const selectedOption = selectElement.selectedOptions[0];
                    const sentenceText = selectedOption.getAttribute("data-sentence");
                    const input = document.createElement("input");
                    input.type = "text";
                    input.value = sentenceText;
                    input.className = "report__input";
                    container.insertBefore(input, selectElement);
                    selectElement.style.display = "none";
                } else {
                    sentenceElement.contentEditable = true;
                }
            } else {
                const sentenceId = sentenceElement ? sentenceElement.getAttribute("data-sentence-id") : selectElement.value;
                const newValue = sentenceElement ? sentenceElement.innerText : container.querySelector(".report__input").value;
    
                fetch("{{ url_for('working_with_reports.update_sentence') }}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        sentence_id: sentenceId,
                        new_value: newValue
                    })
                }).then(response => {
                    if (response.ok) {
                        alert("Sentence updated successfully!");
                        this.innerText = "Edit";
                        if (selectElement) {
                            const input = container.querySelector(".report__input");
                            const selectedOption = selectElement.selectedOptions[0];
                            selectedOption.setAttribute("data-sentence", input.value);
                            selectedOption.textContent = input.value;
                            input.remove();
                            selectElement.style.display = "inline-block";
                        } else {
                            sentenceElement.contentEditable = false;
                        }
                    } else {
                        alert("Failed to update sentence.");
                    }
                });
            }
        });
    });

    document.querySelectorAll(".add-sentence-btn").forEach(button => {
        button.addEventListener("click", function() {
            const container = this.closest(".edit-container");
            const sentenceElement = container.querySelector(".report__sentence");
            const selectElement = container.querySelector(".report__select");
    
            let paragraphId;
            if (selectElement) {
                paragraphId = selectElement.getAttribute("data-index").split("-")[2];
            } else {
                paragraphId = container.closest(".report__paragraph").querySelector("p").getAttribute("data-paragraph-id");
            }
    
            const currentIndex = selectElement ? parseInt(selectElement.selectedOptions[0].value) : parseInt(sentenceElement.getAttribute("data-sentence-id"));
            const newIndex = currentIndex + 1;
    
            fetch("{{ url_for('working_with_reports.add_sentence') }}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    paragraph_id: paragraphId,
                    index: newIndex,
                    new_sentence: "New sentence"
                })
            }).then(response => {
                if (response.ok) {
                    alert("Sentence added successfully!");
                    location.reload(); // Reload the page to show the new sentence
                } else {
                    alert("Failed to add sentence.");
                }
            });
        });
    });
    
    
    
    document.getElementById("left-paragraph-list").addEventListener("change", function(event) {
        if (event.target.tagName === "SELECT") {
            const index = event.target.getAttribute("data-index");
            const selectedOption = event.target.selectedOptions[0];
            const selectedSentence = selectedOption.getAttribute("data-sentence");
            const correspondingIndex = index.replace("left-side", "right-side");
            const correspondingParagraph = document.querySelector('[data-index="' + correspondingIndex + '"]');
            correspondingParagraph.innerText = selectedSentence;
        }
    });
    
    document.getElementById("copyButton").addEventListener("click", function() {
        const rightParagraphList = document.getElementById("right-paragraph-list");
        let textToCopy = "";
        rightParagraphList.querySelectorAll("p").forEach(function(paragraph) {
            if (window.getComputedStyle(paragraph).display !== "none") {
                textToCopy += paragraph.innerText + "\n";
            }
        });
        navigator.clipboard.writeText(textToCopy).then(function() {
            alert("Text copied to clipboard");
        }).catch(function(err) {
            console.error("Failed to copy text: ", err);
        });
    });
</script>

{% endblock container %}
