<!-- edit_report.html -->

{% extends "base.html" %}
{% from "macros/edit_sentence_buttons.html" import control_buttons, info_icons %}
{% from "macros/all_popups.html" import buffer_popup, share_popup %}
{% from "macros/editor_checkboxes.html" import editor_checkboxes%}


{% block container %}
{{ super() }}
<input type="hidden" id="csrf_token" name="csrf_token" value="{{ csrf_token() }}">


<div class="container edit-report" id="editReportContainer">
    {% if report_data %}
    <form class="edit-report__form--report" id="edit-report-form">
        <div class="flex">
            <div class="edit-report__input-block">
                <label class="report_label__item" for="report_type">Report Type:</label>
                <input class="input report_input__item report_input__item--type" id="report_type" name="report_type" value="{{ report_data.report_type }}" readonly>
            </div>
            <div class="edit-report__input-block">
                <label class="report_label__item" for="report_subtype">Report Subtype:</label>
                <input class="input report_input__item" id="report_subtype" name="report_subtype" value="{{ report_data.report_subtype }}" readonly>
            </div>
            <div class="edit-report__input-block">
                <label class="report_label__item" for="report_name">Report Name:</label>
                <input class="input report_input__item" type="text" id="reportName" name="report_name" value="{{ report_data.report_name }}" required>
            </div>
            <div class="edit-report__input-block">
                <label class="report_label__item" for="comment">Comment:</label>
                <input class="input report_input__item" type="text" id="reportComment" name="comment" value="{{ report_data.comment }}" required>
            </div>
            <!-- side boolean changer -->
            <div class="edit-report__input-block">
                <label class="report_label__item">–£—á–∏—Ç—ã–≤–∞—Ç—å —Å—Ç–æ—Ä–æ–Ω—É:</label> <!-- –ü–æ–¥–ø–∏—Å—å –¥–ª—è —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–æ–∫ -->
                <div class="flex_row">
                    <input type="radio" name="report_side" value="True" class="form-check-input" {% if report_data.report_side == True %}checked{% endif %}> 
                    <label for="report_side_yes" class="report_label__item">–î–∞</label>
                    <input type="radio" name="report_side" value="False" class="form-check-input" {% if report_data.report_side == False %}checked{% endif %}> 
                    <label for="report_side_no" class="report_label__item">–ù–µ—Ç</label>
                </div>
            </div>
            <!-- –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–æ–∫ -->
            {{editor_checkboxes(user_settings, report_level=True)}}

            
            <button class="btn report__btn" type="button" id="updateReportButton">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –≤—ã–∑–æ–≤–∞ –ø–æ–ø–∞–ø–∞ –±—É—Ñ–µ—Ä–∞ -->
            <button type="button" id="openBufferPopupButton" class="btn btn-icon btn-open-buffer" title="–û—Ç–∫—Ä—ã—Ç—å –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞">
                üìã –ë—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
            </button>
            <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è —à–∞—Ä–∏–Ω–≥–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ -->
            <button class="btn report__btn" type="button" id="shareReportButton">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>

            <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –ø—Ä–æ—Ç–æ–∫–æ–ª –æ–±—â–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º, –≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω—É -->
            {% if user_max_rank == 4 %}
                <button class="btn report__btn" type="button" id="makeReportPublicButton" data-report-public="report_data.report_public">
                    {% if not report_data.report_public %}
                        –°–¥–µ–ª–∞—Ç—å –æ–±—â–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º
                    {% else %}
                        –°–¥–µ–ª–∞—Ç—å –ø—Ä–∏–≤–∞—Ç–Ω—ã–º
                    {% endif %}
                </button>
            {% endif %}
             
        </div>
    </form>
    <br>
    <hr class="sentence-separator">
    
    <br>

    <div class="report_borderline"></div>
    <div class="edit-paragraph">
       
            <!-- –£—Ä–æ–≤–µ–Ω—å –ø–∞—Ä–∞–≥—Ä–∞—Ñ–∞ -->
            {% if report_paragraphs %}
                <ul class="edit-paragraph__list" id="editParagraphsList">
                    {% for paragraph in report_paragraphs %}

                        {% if paragraph.str_before or paragraph.is_impression%}
                            <br>
                        {% endif %}
                        
                        <li class="wrapper__card edit-paragraph__item
                            {% if paragraph.is_impression %}
                            wrapper__card--impression
                            {% elif paragraph.is_active %}
                            wrapper__card--text
                            {% endif %}
                            "
                            data-paragraph-id="{{ paragraph.id }}">

                            
                            <div class="edit-paragraph__title-wrapper">
                                <div class="drag-handle">‚ò∞</div> <!-- –•–≤–∞—Ç–∞–ª–∫–∞ -->

                                <div class="edit-paragraph__info-box">
                                    <h3 class="edit-paragraph__title
                                        {% if paragraph.bold_paragraph %}
                                        paragraph__text--bold
                                        {% endif %}
                                        {% if not paragraph.paragraph_visible %}
                                        edit-paragraph__title--invisible
                                        {% endif %}
                                        "
                                        data-paragraph-id="{{ paragraph.id }}"
                                        data-paragraph-index="{{ paragraph.paragraph_index }}"
                                        data-paragraph-weight="{{ paragraph.paragraph_weight }}"
                                        data-paragraph-tags="{{ paragraph.tags }}"
                                        data-paragraph-comment="{{ paragraph.comment }}"
                                        data-paragraph-visible="{{ paragraph.paragraph_visible }}"
                                        data-bold-paragraph="{{ paragraph.bold_paragraph }}"
                                        data-title-paragraph="{{ paragraph.title_paragraph }}"
                                        data-paragraph-impression="{{ paragraph.is_impression }}"
                                        data-paragraph-active="{{ paragraph.is_active }}"
                                        data-paragraph-str-before="{{ paragraph.str_before }}"
                                        data-paragraph-str-after="{{ paragraph.str_after }}"
                                        data-paragraph-additional="{{ paragraph.is_additional }}"
                                
                                        {% if not paragraph.title_paragraph %}
                                        style="display: inline;"
                                        {% else %}
                                        style="display: block;"
                                        {% endif %}
                                        >
                                        <b class=""> {{ paragraph.paragraph }} </b>
                                    </h3>
                                
                                        {% for sentence in paragraph.head_sentences %}
                                            <span class="edit-sentence__item" data-sentence-id="{{ sentence.id }}">
                                                {{ sentence.sentence }}
                                            </span>
                                        {% endfor %}
                                
                                </div>
                            </div>
                            
                            <div class="control-buttons__wrapper">
                                <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–∑ –º–∞–∫—Ä–æ—Å–∞ -->
                                {{ control_buttons(paragraph.id, 'paragraph', report_data.id, paragraph.paragraph, report_data.report_type) }}
                                
                            </div>

                        </li>

                        {% if paragraph.str_after %}
                            <br>
                        {% endif %}
                    {% endfor %}
                </ul>
            {% endif %}
            <br>
            <hr class="sentence-separator">
            <br>
            <div class="">
                <label class="label edit-paragraph__label" for="new_paragraph">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø–∞—Ä–∞–≥—Ä–∞—Ñ</label> 
                <button class="btn report__btn edit-paragraph__button" type="button" id="addParagraphButton">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
    </div>
    
    {% else %}
    <p>Report not found or you don't have permission to edit it.</p>
    
    <!-- List of tables and buttons for editing -->
    {% endif %}
</div>

<div class="report-checks">
    <div class="report-checks__buttons-block">
        <h3 class="report-checks_title">–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞</h3>
        <button class"btn report__btn report-checks__btn" 
            id="startCheckersButton" 
            > –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ 
        </button>
    </div>

    <ul class="report-checks__list" id="reportCheckList" style="display: none;">
        <!-- –û—Ç—á–µ—Ç —Å —Å–µ—Ä–≤–µ—Ä–∞, –∑–∞–ø–æ–ª–Ω—é –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ js -->
    </ul>
</div>


<!-- –ü–æ–ø–∞–ø —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏ -->
<div id="paragraphPopup" class="sentence-popup" style="display: none;">
    <div class="sentence-popup__info-box">
        <span class="sentence-popup__info-item"><strong>ID:</strong> <span id="popupElementId"></span></span>
        <span class="sentence-popup__info-item"><strong>–ò–Ω–¥–µ–∫—Å:</strong> <span id="popupElementIndex"></span></span>
        <span class="sentence-popup__info-item"><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> <span id="popupElementComment"></span></span>
        <span class="sentence-popup__info-item"><strong>–¢–µ–≥–∏:</strong> <span id="popupElementTags"></span></span>
    </div>
    <div class="flex_column sentence-pupup_edit-box">
        <div class="sentence-popup__checkbox-wrapper">
            <input type="checkbox" id="elementVisibleCheckbox" class="sentence-popup__checkbox--visible">
            <label for="elementVisibleCheckbox" class="form-check-label">–í–∏–¥–∏–º–æ—Å—Ç—å</label>
        </div>
        <div class="sentence-popup__checkbox-wrapper">
            <input type="checkbox" id="elementBoldCheckbox" class="sentence-popup__checkbox--bold">
            <label for="elementBoldCheckbox" class="form-check-label">–ñ–∏—Ä–Ω—ã–π</label>
        </div>
        <div class="sentence-popup__checkbox-wrapper">
            <input type="checkbox" id="elementTitleCheckbox" class="sentence-popup__checkbox--title">
            <label for="elementTitleCheckbox" class="form-check-label">–ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏</label>
        </div>
        <div class="sentence-popup__checkbox-wrapper">
            <input type="checkbox" id="elementImpressionCheckbox" class="sentence-popup__checkbox--impression">
            <label for="elementImpressionCheckbox" class="sentence-popup__checkbox--impression">–ó–∞–∫–ª—é—á–µ–Ω–∏–µ</label>
        </div>
        <div class="sentence-popup__checkbox-wrapper">
            <input type="checkbox" id="elementIsActiveCheckbox" class="sentence-popup__checkbox--active">
            <label for="elementIsActiveCheckbox" class="sentence-popup__checkbox--active">–ê–∫—Ç–∏–≤–Ω—ã–π</label>
        </div>
        <div class="sentence-popup__checkbox-wrapper">
            <input type="checkbox" id="elementStrBefore" class="sentence-popup__checkbox--str-before">
            <label for="elementStrBefore" class="sentence-popup__checkbox--str-before">–°—Ç—Ä–æ–∫–∞ –¥–æ</label>
        </div>
        <div class="sentence-popup__checkbox-wrapper">
            <input type="checkbox" id="elementStrAfter" class="sentence-popup__checkbox--str-after">
            <label for="elementStrAfter" class="sentence-popup__checkbox--str-after">–°—Ç—Ä–æ–∫–∞ –ø–æ—Å–ª–µ</label>
        </div>
        <div class="sentence-popup__checkbox-wrapper">
            <input type="checkbox" id="elementIsAdditional" class="sentence-popup__checkbox--additional">
            <label for="elementIsAdditional" class="sentence-popup__checkbox--additional">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π</label>
        </div>
        <button id="paragraphPopupSaveChangesButton" class="btn report__btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <button id="closeParagraphPopupButton" class="btn report__btn">–ó–∞–∫—Ä—ã—Ç—å</button>
</div>


<!-- –ë—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ (–ø–æ–ø–∞–ø) –∏–∑ –º–∞–∫—Ä–æ—Å–∞ -->
{{ buffer_popup() }}

<!-- –ü–æ–ø–∞–ø –¥–ª—è —à–∞—Ä–∏–Ω–≥–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –ø–æ email -->
{{ share_popup() }}

    
{% endblock container %}

{% block scripts %}
<script>
    const reportData = {{ report_data | tojson | safe }};
    const reportParagraphs = {{ report_paragraphs | tojson | safe }};
</script>

<script src="{{ url_for('static', filename='js/buffer_popup.js') }}"></script>
<script src="{{ url_for('static', filename='js/sentence_buffer.js') }}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script src="{{ url_for('static', filename='js/edit_report.js') }}"></script>
{% endblock scripts %}